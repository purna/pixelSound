<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive Indexer</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0e0f;
    --surface: #161618;
    --surface2: #1e1e21;
    --border: #2a2a2e;
    --accent: #5b6bff;
    --accent2: #a78bfa;
    --green: #34d399;
    --yellow: #fbbf24;
    --red: #f87171;
    --text: #e8e8ea;
    --muted: #6b6b75;
    --mono: 'DM Mono', monospace;
    --sans: 'DM Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    font-size: 14px;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 28px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--mono);
    font-size: 15px;
    letter-spacing: -0.3px;
  }
  .logo-icon {
    width: 28px; height: 28px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
  }
  .status-pill {
    font-family: var(--mono);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    display: flex; align-items: center; gap: 6px;
  }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); }
  .status-dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }

  /* â”€â”€ LAYOUT â”€â”€ */
  .app { display: flex; height: calc(100vh - 57px); }
  .sidebar {
    width: 300px;
    min-width: 300px;
    border-right: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .main { flex: 1; overflow-y: auto; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar-section {
    padding: 18px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }
  .input-group { display: flex; flex-direction: column; gap: 8px; }
  input[type="text"], input[type="password"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 9px 12px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    width: 100%;
    transition: border-color 0.2s;
    outline: none;
  }
  input::placeholder { color: var(--muted); }
  input:focus { border-color: var(--accent); }
  .btn {
    padding: 9px 16px;
    border-radius: 7px;
    border: none;
    cursor: pointer;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 7px;
  }
  .btn-primary {
    background: var(--accent);
    color: white;
  }
  .btn-primary:hover { background: #4a5be0; transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-ghost {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ STATS â”€â”€ */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stat-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }
  .stat-num {
    font-family: var(--mono);
    font-size: 22px;
    font-weight: 500;
    color: var(--accent);
    line-height: 1;
  }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 3px; }

  /* â”€â”€ TYPE BREAKDOWN â”€â”€ */
  .type-list { display: flex; flex-direction: column; gap: 6px; }
  .type-row {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px;
  }
  .type-bar-wrap { flex: 1; height: 4px; background: var(--border); border-radius: 2px; margin: 0 10px; }
  .type-bar { height: 100%; border-radius: 2px; background: var(--accent); transition: width 0.5s ease; }
  .type-count { font-family: var(--mono); font-size: 11px; color: var(--muted); }

  /* â”€â”€ MAIN CONTENT â”€â”€ */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .search-wrap {
    flex: 1;
    position: relative;
  }
  .search-icon {
    position: absolute;
    left: 12px; top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 13px;
  }
  .search-wrap input {
    padding-left: 34px;
    font-family: var(--sans);
    font-size: 13px;
  }
  .view-tabs {
    display: flex;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .tab-btn {
    padding: 7px 14px;
    font-size: 12px;
    font-family: var(--mono);
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--muted);
    transition: all 0.15s;
    letter-spacing: 0.3px;
  }
  .tab-btn.active { background: var(--accent); color: white; }
  .sort-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 7px 10px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    outline: none;
  }

  /* â”€â”€ FILE LIST â”€â”€ */
  .file-list { padding: 16px 24px; display: flex; flex-direction: column; gap: 6px; }
  .file-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: flex-start;
    gap: 14px;
    transition: border-color 0.15s, transform 0.15s;
    cursor: pointer;
    animation: slideIn 0.25s ease forwards;
    opacity: 0;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .file-card:hover { border-color: var(--accent); transform: translateX(2px); }
  .file-card.expanded { border-color: var(--accent2); }
  .file-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px;
    flex-shrink: 0;
  }
  .file-info { flex: 1; min-width: 0; }
  .file-name {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
  }
  .file-meta {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    display: flex; gap: 12px; flex-wrap: wrap;
  }
  .file-type-badge {
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 4px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    flex-shrink: 0;
    align-self: flex-start;
    margin-top: 2px;
  }
  .file-summary {
    margin-top: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 7px;
    border-left: 2px solid var(--accent2);
    font-size: 12px;
    line-height: 1.6;
    color: #c0c0cc;
    display: none;
  }
  .file-summary.visible { display: block; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .summary-loading {
    display: flex; align-items: center; gap: 8px; color: var(--muted);
    font-family: var(--mono); font-size: 11px;
  }
  .spinner {
    width: 12px; height: 12px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ CATALOGUE VIEW â”€â”€ */
  .catalogue { padding: 24px; }
  .cat-group { margin-bottom: 28px; }
  .cat-group-header {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  .cat-group-title {
    font-family: var(--mono);
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent2);
  }
  .cat-group-count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    background: var(--surface2);
    padding: 2px 8px;
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; }
  .cat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    display: flex; align-items: center; gap: 10px;
    transition: border-color 0.15s;
    cursor: pointer;
    animation: slideIn 0.2s ease forwards;
    opacity: 0;
  }
  .cat-card:hover { border-color: var(--accent); }
  .cat-card-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cat-card-meta { font-family: var(--mono); font-size: 10px; color: var(--muted); margin-top: 2px; }

  /* â”€â”€ EMPTY â”€â”€ */
  .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 300px; gap: 12px; color: var(--muted);
    font-family: var(--mono); font-size: 12px; text-align: center;
  }
  .empty-icon { font-size: 36px; opacity: 0.3; }

  /* â”€â”€ PROGRESS â”€â”€ */
  .progress-bar-wrap {
    height: 2px; background: var(--border);
    position: fixed; top: 57px; left: 300px; right: 0; z-index: 200;
    opacity: 0; transition: opacity 0.2s;
  }
  .progress-bar-wrap.visible { opacity: 1; }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 0.3s ease;
  }

  /* â”€â”€ SETUP SCREEN â”€â”€ */
  #setup-screen {
    display: flex; align-items: center; justify-content: center;
    height: 100%; padding: 40px;
  }
  .setup-card {
    max-width: 520px; width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 36px;
  }
  .setup-title { font-size: 22px; font-weight: 600; margin-bottom: 6px; }
  .setup-subtitle { color: var(--muted); font-size: 13px; margin-bottom: 28px; line-height: 1.6; }
  .setup-steps { display: flex; flex-direction: column; gap: 16px; margin-bottom: 28px; }
  .setup-step {
    display: flex; align-items: flex-start; gap: 12px;
    background: var(--surface2); border-radius: 10px; padding: 14px;
    border: 1px solid var(--border);
  }
  .step-num {
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--accent); color: white;
    font-family: var(--mono); font-size: 11px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 1px;
  }
  .step-text { font-size: 12px; line-height: 1.6; color: var(--muted); }
  .step-text strong { color: var(--text); }
  .step-link { color: var(--accent); text-decoration: none; }
  .step-link:hover { text-decoration: underline; }
  .setup-fields { display: flex; flex-direction: column; gap: 10px; }
  .field-label { font-size: 11px; color: var(--muted); margin-bottom: 3px; font-family: var(--mono); }
  .demo-btn {
    background: transparent; border: 1px dashed var(--border);
    color: var(--muted); font-size: 12px; margin-top: 8px;
    padding: 8px; border-radius: 7px; cursor: pointer; width: 100%;
    transition: all 0.15s; font-family: var(--mono);
  }
  .demo-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ SCROLLBAR â”€â”€ */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ðŸ“‚</div>
    drive indexer
  </div>
  <div class="status-pill" id="status-pill">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-text">not connected</span>
  </div>
</header>

<div class="progress-bar-wrap" id="progress-wrap">
  <div class="progress-bar" id="progress-bar" style="width:0%"></div>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-card">
    <div class="setup-title">Connect Google Drive</div>
    <div class="setup-subtitle">Index any folder â€” get a searchable file list, AI-generated summaries, and a structured catalogue by type and date.</div>

    <div class="setup-steps">
      <div class="setup-step">
        <div class="step-num">1</div>
        <div class="step-text">
          Go to <a class="step-link" href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>, create a project, enable the <strong>Google Drive API</strong>, and create an <strong>API Key</strong>.
        </div>
      </div>
      <div class="setup-step">
        <div class="step-num">2</div>
        <div class="step-text">
          Restrict the API key to the <strong>Drive API</strong>. For private folders, also set up an OAuth client. Public shared folders only need the API key.
        </div>
      </div>
      <div class="setup-step">
        <div class="step-num">3</div>
        <div class="step-text">
          Get your <strong>Folder ID</strong> from the Drive URL: <code style="background:var(--border);padding:1px 5px;border-radius:3px;font-size:11px;">drive.google.com/drive/folders/<strong>FOLDER_ID</strong></code>
        </div>
      </div>
    </div>

    <div class="setup-fields">
      <div>
        <div class="field-label">GOOGLE DRIVE API KEY</div>
        <input type="password" id="api-key-input" placeholder="AIzaSy..." />
      </div>
      <div>
        <div class="field-label">FOLDER ID</div>
        <input type="text" id="folder-id-input" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs" />
      </div>
      <div>
        <div class="field-label">ANTHROPIC API KEY (for AI summaries)</div>
        <input type="password" id="anthropic-key-input" placeholder="sk-ant-..." />
      </div>
      <button class="btn btn-primary" onclick="connectDrive()">
        <span>ðŸ”—</span> Connect & Index
      </button>
      <button class="demo-btn" onclick="loadDemoData()">
        âœ¦ Load demo data (no API key needed)
      </button>
    </div>
  </div>
</div>

<!-- MAIN APP (hidden until connected) -->
<div id="app" class="app" style="display:none;">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Folder</div>
      <div id="folder-name" style="font-size:13px;font-weight:500;margin-bottom:10px;word-break:break-all;"></div>
      <button class="btn btn-ghost" style="width:100%;font-size:12px;" onclick="showSetup()">â†© Change folder</button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Overview</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-num" id="stat-total">0</div>
          <div class="stat-label">total files</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="stat-types" style="color:var(--accent2)">0</div>
          <div class="stat-label">file types</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="stat-size" style="color:var(--green);font-size:16px;">0</div>
          <div class="stat-label">total size</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="stat-folders" style="color:var(--yellow)">0</div>
          <div class="stat-label">subfolders</div>
        </div>
      </div>
    </div>

    <div class="sidebar-section" style="flex:1;overflow-y:auto;">
      <div class="sidebar-label">By type</div>
      <div class="type-list" id="type-breakdown"></div>
    </div>

    <div class="sidebar-section">
      <button class="btn btn-ghost" style="width:100%;font-size:12px;" onclick="exportIndex()">
        â¬‡ Export index as JSON
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">âŒ•</span>
        <input type="text" id="search-input" placeholder="Search files by name, type, date..." oninput="renderFiles()" />
      </div>
      <div class="view-tabs">
        <button class="tab-btn active" id="tab-list" onclick="switchView('list')">list</button>
        <button class="tab-btn" id="tab-cat" onclick="switchView('catalogue')">catalogue</button>
      </div>
      <select class="sort-select" id="sort-select" onchange="renderFiles()">
        <option value="name">name â†‘</option>
        <option value="name-desc">name â†“</option>
        <option value="date">newest</option>
        <option value="date-asc">oldest</option>
        <option value="size">largest</option>
        <option value="type">type</option>
      </select>
    </div>
    <div id="content-area"></div>
  </main>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apiKey = '';
let folderId = '';
let anthropicKey = '';
let allFiles = [];
let currentView = 'list';
let summaryCache = {};

// â”€â”€ FILE TYPE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const typeConfig = {
  'application/vnd.google-apps.document':        { label:'Doc',    icon:'ðŸ“„', color:'#4285f4', bg:'#1a2a4a' },
  'application/vnd.google-apps.spreadsheet':     { label:'Sheet',  icon:'ðŸ“Š', color:'#34a853', bg:'#1a3a2a' },
  'application/vnd.google-apps.presentation':    { label:'Slides', icon:'ðŸ“½', color:'#fbbc04', bg:'#3a300a' },
  'application/vnd.google-apps.folder':          { label:'Folder', icon:'ðŸ“', color:'#fbbf24', bg:'#3a2a0a' },
  'application/pdf':                             { label:'PDF',    icon:'ðŸ“•', color:'#f87171', bg:'#3a1a1a' },
  'image/jpeg':                                  { label:'Image',  icon:'ðŸ–¼', color:'#a78bfa', bg:'#2a1a4a' },
  'image/png':                                   { label:'Image',  icon:'ðŸ–¼', color:'#a78bfa', bg:'#2a1a4a' },
  'image/gif':                                   { label:'GIF',    icon:'ðŸŽž', color:'#a78bfa', bg:'#2a1a4a' },
  'video/mp4':                                   { label:'Video',  icon:'ðŸŽ¬', color:'#f472b6', bg:'#3a1a2a' },
  'audio/mpeg':                                  { label:'Audio',  icon:'ðŸŽµ', color:'#34d399', bg:'#0a2a1a' },
  'application/zip':                             { label:'ZIP',    icon:'ðŸ—œ', color:'#94a3b8', bg:'#1a2030' },
  'text/plain':                                  { label:'Text',   icon:'ðŸ“', color:'#e2e8f0', bg:'#1a1a2a' },
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document':   { label:'DOCX', icon:'ðŸ“„', color:'#4285f4', bg:'#1a2a4a' },
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':         { label:'XLSX', icon:'ðŸ“Š', color:'#34a853', bg:'#1a3a2a' },
  'application/vnd.openxmlformats-officedocument.presentationml.presentation': { label:'PPTX', icon:'ðŸ“½', color:'#fbbc04', bg:'#3a300a' },
};
function getType(mimeType) {
  return typeConfig[mimeType] || { label: mimeType?.split('/')[1]?.toUpperCase() || 'File', icon:'ðŸ“Ž', color:'#6b7280', bg:'#1a1a1a' };
}

// â”€â”€ CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function connectDrive() {
  apiKey = document.getElementById('api-key-input').value.trim();
  folderId = document.getElementById('folder-id-input').value.trim();
  anthropicKey = document.getElementById('anthropic-key-input').value.trim();

  if (!apiKey || !folderId) {
    alert('Please enter both an API key and Folder ID.');
    return;
  }

  setProgress(10);
  try {
    await indexFolder(folderId, apiKey);
    showApp();
  } catch(e) {
    alert('Failed to connect: ' + e.message + '\n\nCheck your API key and folder ID. Make sure the folder is shared publicly or the API key has access.');
    setProgress(0);
  }
}

async function indexFolder(fid, key, parentName = 'Root') {
  setStatus('indexing...', false);
  setProgress(20);

  // Get folder name
  const metaRes = await fetch(
    `https://www.googleapis.com/drive/v3/files/${fid}?fields=name&key=${key}`
  );
  if (!metaRes.ok) throw new Error(`Drive API error: ${metaRes.status} ${metaRes.statusText}`);
  const meta = await metaRes.json();
  document.getElementById('folder-name').textContent = meta.name || 'My Folder';

  allFiles = [];
  await fetchAllFiles(fid, key);
  setProgress(90);
  updateStats();
  setProgress(100);
  setTimeout(() => setProgress(0), 600);
  setStatus('connected Â· ' + allFiles.length + ' files', true);
}

async function fetchAllFiles(fid, key, pageToken = null) {
  let url = `https://www.googleapis.com/drive/v3/files?q='${fid}'+in+parents+and+trashed=false`
    + `&fields=nextPageToken,files(id,name,mimeType,size,modifiedTime,createdTime,parents)`
    + `&pageSize=100&key=${key}`;
  if (pageToken) url += `&pageToken=${pageToken}`;

  const res = await fetch(url);
  if (!res.ok) throw new Error(`Drive API error: ${res.status}`);
  const data = await res.json();
  allFiles.push(...(data.files || []));

  if (data.nextPageToken) {
    await fetchAllFiles(fid, key, data.nextPageToken);
  }
}

// â”€â”€ DEMO DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDemoData() {
  apiKey = 'demo'; folderId = 'demo'; anthropicKey = '';
  document.getElementById('folder-name').textContent = 'My Projects (demo)';

  const now = new Date();
  const ago = (d) => new Date(now - d * 86400000).toISOString();
  allFiles = [
    { id:'1', name:'Q4 Financial Report.pdf', mimeType:'application/pdf', size:'2048000', modifiedTime:ago(2), createdTime:ago(60) },
    { id:'2', name:'Project Roadmap.gdoc', mimeType:'application/vnd.google-apps.document', size:'', modifiedTime:ago(1), createdTime:ago(30) },
    { id:'3', name:'Budget 2024.gsheet', mimeType:'application/vnd.google-apps.spreadsheet', size:'', modifiedTime:ago(5), createdTime:ago(90) },
    { id:'4', name:'Team Photo.jpg', mimeType:'image/jpeg', size:'3500000', modifiedTime:ago(10), createdTime:ago(120) },
    { id:'5', name:'Product Demo.mp4', mimeType:'video/mp4', size:'150000000', modifiedTime:ago(7), createdTime:ago(45) },
    { id:'6', name:'Design Assets', mimeType:'application/vnd.google-apps.folder', size:'', modifiedTime:ago(3), createdTime:ago(180) },
    { id:'7', name:'API Docs.pdf', mimeType:'application/pdf', size:'512000', modifiedTime:ago(14), createdTime:ago(200) },
    { id:'8', name:'Investor Deck.gslides', mimeType:'application/vnd.google-apps.presentation', size:'', modifiedTime:ago(20), createdTime:ago(150) },
    { id:'9', name:'README.txt', mimeType:'text/plain', size:'8192', modifiedTime:ago(1), createdTime:ago(365) },
    { id:'10', name:'Archive.zip', mimeType:'application/zip', size:'25600000', modifiedTime:ago(30), createdTime:ago(400) },
    { id:'11', name:'Meeting Notes Oct.gdoc', mimeType:'application/vnd.google-apps.document', size:'', modifiedTime:ago(3), createdTime:ago(25) },
    { id:'12', name:'Logo Final.png', mimeType:'image/png', size:'450000', modifiedTime:ago(60), createdTime:ago(300) },
    { id:'13', name:'Podcast Intro.mp3', mimeType:'audio/mpeg', size:'5000000', modifiedTime:ago(15), createdTime:ago(100) },
    { id:'14', name:'Sales Data Q3.xlsx', mimeType:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', size:'980000', modifiedTime:ago(8), createdTime:ago(95) },
    { id:'15', name:'Onboarding Slides.pptx', mimeType:'application/vnd.openxmlformats-officedocument.presentationml.presentation', size:'7200000', modifiedTime:ago(45), createdTime:ago(220) },
  ];

  updateStats();
  showApp();
  setStatus('demo Â· ' + allFiles.length + ' files', true);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFiles() {
  if (currentView === 'list') renderList();
  else renderCatalogue();
}

function getFiltered() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const sort = document.getElementById('sort-select').value;

  let files = allFiles.filter(f => {
    if (!q) return true;
    const t = getType(f.mimeType);
    return f.name.toLowerCase().includes(q)
      || t.label.toLowerCase().includes(q)
      || (f.modifiedTime || '').includes(q);
  });

  files.sort((a, b) => {
    if (sort === 'name') return a.name.localeCompare(b.name);
    if (sort === 'name-desc') return b.name.localeCompare(a.name);
    if (sort === 'date') return new Date(b.modifiedTime) - new Date(a.modifiedTime);
    if (sort === 'date-asc') return new Date(a.modifiedTime) - new Date(b.modifiedTime);
    if (sort === 'size') return (parseInt(b.size)||0) - (parseInt(a.size)||0);
    if (sort === 'type') return a.mimeType.localeCompare(b.mimeType);
    return 0;
  });
  return files;
}

function renderList() {
  const files = getFiltered();
  const area = document.getElementById('content-area');

  if (!files.length) {
    area.innerHTML = `<div class="empty-state"><div class="empty-icon">â—Ž</div><div>no files match your search</div></div>`;
    return;
  }

  area.innerHTML = `<div class="file-list" id="file-list-inner"></div>`;
  const list = document.getElementById('file-list-inner');

  files.forEach((f, i) => {
    const t = getType(f.mimeType);
    const date = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : 'â€”';
    const size = f.size ? formatSize(parseInt(f.size)) : 'â€”';

    const card = document.createElement('div');
    card.className = 'file-card';
    card.style.animationDelay = (i * 0.03) + 's';
    card.dataset.id = f.id;

    card.innerHTML = `
      <div class="file-icon" style="background:${t.bg};">${t.icon}</div>
      <div class="file-info">
        <div class="file-name">${escHtml(f.name)}</div>
        <div class="file-meta">
          <span>${date}</span>
          <span>${size}</span>
          ${f.id ? `<span style="color:var(--accent);cursor:pointer;" onclick="openFile('${f.id}',event)">â†— open</span>` : ''}
        </div>
        <div class="file-summary" id="summary-${f.id}"></div>
      </div>
      <div class="file-type-badge" style="background:${t.bg};color:${t.color};">${t.label}</div>
    `;

    card.addEventListener('click', (e) => {
      if (e.target.closest('[onclick]')) return;
      toggleSummary(f, card);
    });

    list.appendChild(card);
  });
}

function renderCatalogue() {
  const files = getFiltered();
  const area = document.getElementById('content-area');

  if (!files.length) {
    area.innerHTML = `<div class="empty-state"><div class="empty-icon">â—Ž</div><div>no files match your search</div></div>`;
    return;
  }

  // Group by type
  const groups = {};
  files.forEach(f => {
    const t = getType(f.mimeType);
    if (!groups[t.label]) groups[t.label] = { config: t, files: [] };
    groups[t.label].files.push(f);
  });

  const sorted = Object.entries(groups).sort((a,b) => b[1].files.length - a[1].files.length);
  let html = '<div class="catalogue">';

  sorted.forEach(([label, group], gi) => {
    html += `<div class="cat-group">
      <div class="cat-group-header">
        <span style="font-size:18px;">${group.config.icon}</span>
        <span class="cat-group-title">${label}</span>
        <span class="cat-group-count">${group.files.length}</span>
      </div>
      <div class="cat-grid">`;

    group.files.forEach((f, i) => {
      const date = f.modifiedTime ? new Date(f.modifiedTime).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : 'â€”';
      const delay = (gi * 0.05 + i * 0.02) + 's';
      html += `<div class="cat-card" style="animation-delay:${delay};" onclick="openFile('${f.id}',event)">
        <span style="font-size:20px;">${group.config.icon}</span>
        <div>
          <div class="cat-card-name">${escHtml(f.name)}</div>
          <div class="cat-card-meta">${date}</div>
        </div>
      </div>`;
    });

    html += `</div></div>`;
  });

  html += '</div>';
  area.innerHTML = html;
}

// â”€â”€ SUMMARIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleSummary(file, card) {
  card.classList.toggle('expanded');
  const summaryEl = document.getElementById('summary-' + file.id);
  if (!summaryEl) return;

  if (summaryEl.classList.contains('visible')) {
    summaryEl.classList.remove('visible');
    return;
  }

  summaryEl.classList.add('visible');

  if (summaryCache[file.id]) {
    summaryEl.innerHTML = summaryCache[file.id];
    return;
  }

  summaryEl.innerHTML = `<div class="summary-loading"><div class="spinner"></div> generating summary...</div>`;

  if (!anthropicKey || anthropicKey === '') {
    const t = getType(file.mimeType);
    const date = file.modifiedTime ? new Date(file.modifiedTime).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : 'unknown date';
    const size = file.size ? formatSize(parseInt(file.size)) : 'unknown size';
    const summary = `<strong>${t.icon} ${t.label}</strong> Â· Last modified <strong>${date}</strong> Â· Size: <strong>${size}</strong><br><span style="color:var(--muted);font-style:italic;">Add an Anthropic API key to generate AI content summaries.</span>`;
    summaryCache[file.id] = summary;
    summaryEl.innerHTML = summary;
    return;
  }

  try {
    const prompt = `You are indexing a Google Drive folder. Given the following file metadata, write a concise 1-2 sentence summary describing what this file likely contains and its purpose. Be specific and practical.

File name: ${file.name}
Type: ${getType(file.mimeType).label}
Size: ${file.size ? formatSize(parseInt(file.size)) : 'unknown'}
Modified: ${file.modifiedTime || 'unknown'}
Created: ${file.createdTime || 'unknown'}

Respond with only the summary sentence(s), no preamble.`;

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await res.json();
    const text = data.content?.map(c => c.text).join('') || 'Could not generate summary.';
    const html = `<strong>${getType(file.mimeType).icon} AI Summary:</strong> ${escHtml(text)}`;
    summaryCache[file.id] = html;
    summaryEl.innerHTML = html;
  } catch(e) {
    summaryEl.innerHTML = `<span style="color:var(--red)">Summary failed: ${e.message}</span>`;
  }
}

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const total = allFiles.length;
  const folders = allFiles.filter(f => f.mimeType === 'application/vnd.google-apps.folder').length;
  const totalSize = allFiles.reduce((a, f) => a + (parseInt(f.size) || 0), 0);

  const typeCounts = {};
  allFiles.forEach(f => {
    const label = getType(f.mimeType).label;
    typeCounts[label] = (typeCounts[label] || 0) + 1;
  });
  const typeCount = Object.keys(typeCounts).length;

  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-types').textContent = typeCount;
  document.getElementById('stat-size').textContent = formatSize(totalSize);
  document.getElementById('stat-folders').textContent = folders;

  // Type breakdown
  const breakdown = document.getElementById('type-breakdown');
  const sorted = Object.entries(typeCounts).sort((a,b) => b[1]-a[1]);
  const max = sorted[0]?.[1] || 1;
  breakdown.innerHTML = sorted.map(([label, count]) => {
    const t = Object.values(typeConfig).find(tc => tc.label === label) || { color: '#6b7280', icon: 'ðŸ“Ž' };
    return `<div class="type-row">
      <span style="font-size:13px;">${t.icon}</span>
      <span style="font-size:12px;color:var(--text);min-width:50px;">${label}</span>
      <div class="type-bar-wrap"><div class="type-bar" style="width:${(count/max*100)}%;background:${t.color};"></div></div>
      <span class="type-count">${count}</span>
    </div>`;
  }).join('');
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportIndex() {
  const index = allFiles.map(f => ({
    name: f.name,
    type: getType(f.mimeType).label,
    mimeType: f.mimeType,
    size: f.size ? formatSize(parseInt(f.size)) : null,
    sizeBytes: parseInt(f.size) || null,
    modified: f.modifiedTime,
    created: f.createdTime,
    id: f.id,
    url: f.id && apiKey !== 'demo' ? `https://drive.google.com/file/d/${f.id}/view` : null
  }));

  const blob = new Blob([JSON.stringify(index, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'drive-index.json';
  a.click();
}

// â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchView(v) {
  currentView = v;
  document.getElementById('tab-list').classList.toggle('active', v === 'list');
  document.getElementById('tab-cat').classList.toggle('active', v === 'catalogue');
  renderFiles();
}

function showApp() {
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  renderFiles();
}

function showSetup() {
  document.getElementById('setup-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

function openFile(id, e) {
  if (e) e.stopPropagation();
  if (id && apiKey !== 'demo') {
    window.open(`https://drive.google.com/file/d/${id}/view`, '_blank');
  }
}

function setStatus(text, connected) {
  document.getElementById('status-text').textContent = text;
  document.getElementById('status-dot').className = 'status-dot' + (connected ? ' connected' : '');
}

function setProgress(pct) {
  const wrap = document.getElementById('progress-wrap');
  const bar = document.getElementById('progress-bar');
  wrap.classList.toggle('visible', pct > 0);
  bar.style.width = pct + '%';
}

function formatSize(bytes) {
  if (!bytes) return 'â€”';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  if (bytes < 1073741824) return (bytes/1048576).toFixed(1) + ' MB';
  return (bytes/1073741824).toFixed(2) + ' GB';
}

function escHtml(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
